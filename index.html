<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <meta name="apple-mobile-web-app-title" content="ADHS Kurven" />
  <link rel="manifest" href="./manifest.webmanifest" />
  <title>ADHS Med Kurven (lokal)</title>
  <style>
    :root{
      --bg: #0f1220; --panel: #151832; --panel-2: #1a1f3f; --text: #f4f6ff; --muted: #aab3d0;
      --accent: #6aa0ff; --shadow: 0 10px 25px rgba(0,0,0,.35); --radius: 18px;
      --gap: 14px; --card-pad: 16px; --font-scale: clamp(16px, 1.6vw + 12px, 19px);
    }
    html,body{height:100%;}
    html{ font-size: var(--font-scale); }
    body{
      margin:0; font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
      color:var(--text); background: radial-gradient(1200px 500px at 50% -50%, #192047 0%, #0f1220 60%);
      -webkit-font-smoothing: antialiased; min-height: 100dvh; padding-bottom: env(safe-area-inset-bottom);
      -webkit-tap-highlight-color: transparent; touch-action: manipulation;
    }
    .app{max-width:900px; margin:0 auto; padding:20px 16px calc(40px + env(safe-area-inset-bottom));}
    header{ display:flex; align-items:center; justify-content:space-between; gap:12px; margin-bottom:18px;}
    .title{ font-weight:800; letter-spacing:.4px; font-size:1.5rem; }
    .tag{ background:linear-gradient(135deg,#2a2f63,#1b2047); border:1px solid #2a3066; color:#c9d3ff; padding:8px 12px; border-radius:999px; font-size:.8rem; }
    .grid{ display:grid; grid-template-columns: 1fr; gap:var(--gap);} 
    @media (min-width:800px){ .grid{ grid-template-columns: 1fr 360px; } }
    .card{ background:linear-gradient(180deg, var(--panel), var(--panel-2)); border:1px solid #2a3066; border-radius:var(--radius); box-shadow:var(--shadow); }
    .card h2{ font-size:1rem; font-weight:700; margin:0; padding:14px var(--card-pad); border-bottom:1px solid #2a3066; color:#cfe0ff; }
    .card .content{ padding:var(--card-pad); }
    .row{ display:flex; flex-wrap:wrap; gap:12px; align-items:center; }
    label{ font-size:.9rem; color:var(--muted); display:block; margin-bottom:6px; }
    select,input,textarea,button{ border-radius:14px; border:1px solid #31396f; background:#121632; color:#fff; padding:12px 14px; font-size:16px; }
    select,input{ height:48px; }
    textarea{ width:100%; min-height:100px; resize:vertical; }
    button{ cursor:pointer; font-weight:700; letter-spacing:.3px; min-height:48px; min-width:44px; }
    .btn{ background:linear-gradient(180deg,#25306b,#1a1f46); }
    .btn:hover{ filter:brightness(1.07); }
    .btn-accent{ background:linear-gradient(180deg,#4f7ff8,#3063ee); border-color:#3b63ff; }
    .btn-ghost{ background:transparent; border-color:#3a4077; }
    .pill{ padding:8px 12px; border-radius:12px; border:1px solid #33407a; font-size:.9rem; color:#cbd6ff; }
    .list{ display:flex; flex-direction:column; gap:12px; }
    .dose-item{ display:flex; justify-content:space-between; align-items:center; gap:10px; padding:12px; border:1px dashed #38407a; border-radius:14px; background: #121633; }
    .chart-wrap{ position:relative; height: clamp(280px, 45dvh, 560px); }
    svg{ width:100%; height:100%; display:block; }
    .muted{ color:var(--muted); }
    .now-value{ font-weight:800; font-size:1.75rem; letter-spacing:.4px; }
    footer{ margin-top:16px; color:#98a4d2; font-size:.85rem; }
    .disclaimer{ color:#9fb0ee; font-size:.85rem; line-height:1.6; }
    :focus-visible{ outline:2px solid #7aa2ff; outline-offset:2px; border-color:#7aa2ff; }

    /* Modal */
    .modal{ position:fixed; inset:0; display:none; align-items:center; justify-content:center; z-index:1000; }
    .modal.show{ display:flex; }
    .modal-backdrop{ position:absolute; inset:0; background:rgba(0,0,0,.55); backdrop-filter: blur(2px); }
    .modal-card{ position:relative; width:min(92vw, 480px); background:linear-gradient(180deg, var(--panel), var(--panel-2)); border:1px solid #2a3066; border-radius:20px; box-shadow:var(--shadow); padding:18px; color:var(--text); }
    .modal-card h3{ margin:0 0 8px; font-size:1.1rem; color:#cfe0ff; }
    .modal-card label{ display:flex; align-items:center; justify-content:space-between; gap:12px; }
    .modal-card input{ width:140px; }
  </style>
</head>
<body>
  <div class="app">
    <header>
      <div class="title">ADHS Med Kurven</div>
      <div class="row" style="gap:10px; align-items:center;">
        <div class="tag">Offline • lokal auf diesem iPhone</div>
        <button id="openSettings" class="btn pill">Einstellungen</button>
      </div>
    </header>

    <div class="grid">
      <!-- LEFT: Chart & Notes -->
      <section class="card">
        <h2>Wirkung – letzte 24 Stunden</h2>
        <div class="content">
          <div class="row" style="justify-content:space-between; margin-bottom:8px;">
            <div class="pill">Gesamt (ng/mL) • Jetzt: <span id="nowValue" class="now-value">0.0</span></div>
            <div class="row">
              <button id="btn12" class="btn pill">12h</button>
              <button id="btn24" class="btn pill">24h</button>
              <button id="btn48" class="btn pill">48h</button>
            </div>
          </div>
          <div class="chart-wrap">
            <svg id="chart" viewBox="0 0 1000 300" preserveAspectRatio="none" aria-label="Wirkungsverlauf"></svg>
          </div>
          <div class="muted" style="margin-top:8px;">Tippe auf Dosen-Marker im Diagramm für Details.</div>
        </div>
      </section>

      <!-- RIGHT: Input / List / Export -->
      <section class="card">
        <h2>Eintragen</h2>
        <div class="content">
          <div class="row">
            <div style="flex:1; min-width:200px;">
              <label for="medSel">Präparat & Dosis</label>
              <select id="medSel"></select>
            </div>
            <div>
              <label for="timeSel">Einnahmezeit</label>
              <input id="timeSel" type="datetime-local" />
            </div>
          </div>
          <div class="row" style="margin-top:8px;">
            <button id="addDose" class="btn btn-accent">Dosis hinzufügen</button>
            <button id="addNow" class="btn">Jetzt</button>
          </div>
        </div>
      </section>

      <section class="card">
        <h2>Notiz</h2>
        <div class="content">
          <label for="noteTxt">Wie fühlst du dich (Fokus, Stimmung, Nebenwirkungen …)?</label>
          <textarea id="noteTxt" placeholder="Kurz notieren…"></textarea>
          <div class="row" style="margin-top:8px;">
            <button id="saveNote" class="btn">Notiz mit aktuellem Zeitpunkt speichern</button>
          </div>
          <div id="notesList" class="list" style="margin-top:10px;"></div>
        </div>
      </section>

      <section class="card">
        <h2>Dosenverlauf</h2>
        <div class="content">
          <div id="doseList" class="list"></div>
          <div class="row" style="margin-top:12px; justify-content:space-between;">
            <button id="exportDoctor" class="btn">Arzt‑Export</button>
            <button id="clearAll" class="btn btn-ghost">Alles löschen</button>
          </div>
        </div>
      </section>
    </div>

    <footer>
      <p class="disclaimer">⚠️ Modellierte ng/mL‑Werte (Bateman, F≈0.30, Vd≈2.65 L/kg). Keine Laborwerte und keine Therapieempfehlung.</p>
    </footer>

    <!-- Einstellungen Modal -->
    <div id="settingsModal" class="modal" aria-hidden="true">
      <div class="modal-backdrop"></div>
      <div class="modal-card" role="dialog" aria-modal="true" aria-labelledby="settingsTitle">
        <h3 id="settingsTitle">Einstellungen</h3>
        <label>Gewicht (kg)
          <input id="modalWeight" type="number" min="20" max="200" step="0.5" />
        </label>
        <div class="row" style="margin-top:12px; justify-content:flex-end;">
          <button id="modalCancel" class="btn btn-ghost">Abbrechen</button>
          <button id="modalSave" class="btn btn-accent">Speichern</button>
        </div>
        <p class="muted" style="margin-top:8px;">Einheit: ng/mL (modelliert; F≈0,30; Vd≈2,65 L/kg).</p>
      </div>
    </div>
  </div>

  <script>
  // ————————————————
  // Immer gültige Modelle (Dropdown kann nie leer sein)
  // ————————————————
  const MODELS = {
    ritalin_ir_5:  { label: "Ritalin 5mg", mg: 5,  kind: "IR",        ka: 1.5, ke: 0.231, color: "#7fb3ff" },
    ritalin_ir_10: { label: "Ritalin 10mg", mg: 10, kind: "IR",        ka: 1.5, ke: 0.231, color: "#7fb3ff" },
    sandoz_retard_18:{ label: "Methylphenidat Sandoz retard 18mg", mg: 18, kind: "BIPHASIC", ka: 1.3, ke: 0.231, lag2: 4.0, color: "#85e0a3" },
    concerta_27:   { label: "Concerta 27mg", mg: 27, kind: "CONCERTA", ka: 1.2, ke: 0.231, infusionStart: 1.0, infusionEnd: 11.0, irFraction: 0.22, color: "#f5c36a" },
    concerta_36:   { label: "Concerta 36mg", mg: 36, kind: "CONCERTA", ka: 1.2, ke: 0.231, infusionStart: 1.0, infusionEnd: 11.0, irFraction: 0.22, color: "#f5c36a" }
  };
  const PK = { F: 0.30, VdLkg: 2.65 };

  const STATE = {
    doses: load("doses", []),
    notes: load("notes", []),
    hoursWindow: 24,
    weightKg: load("weightKg", null)
  };

  // Storage helpers
  function save(k,v){ localStorage.setItem(k, JSON.stringify(v)); }
  function load(k, fallback){ try{ return JSON.parse(localStorage.getItem(k)) ?? fallback } catch(e){ return fallback } }
  function uid(){ return Math.random().toString(36).slice(2,9); }

  // Elements
  const medSel = document.getElementById('medSel');
  const timeSel = document.getElementById('timeSel');
  const addDoseBtn = document.getElementById('addDose');
  const addNowBtn = document.getElementById('addNow');
  const doseList = document.getElementById('doseList');
  const chart = document.getElementById('chart');
  const nowValue = document.getElementById('nowValue');
  const btn12 = document.getElementById('btn12');
  const btn24 = document.getElementById('btn24');
  const btn48 = document.getElementById('btn48');
  const notesList = document.getElementById('notesList');
  const noteTxt = document.getElementById('noteTxt');
  const saveNoteBtn = document.getElementById('saveNote');
  const exportBtn = document.getElementById('exportDoctor');
  const clearBtn = document.getElementById('clearAll');
  const openSettingsBtn = document.getElementById('openSettings');

  // Modal elements
  const settingsModal = document.getElementById('settingsModal');
  const modalWeight = document.getElementById('modalWeight');
  const modalSave = document.getElementById('modalSave');
  const modalCancel = document.getElementById('modalCancel');

  // PK math (Bateman + Skalierung ng/mL)
  function bateman(tHours, doseMg, ka, ke){
    if(tHours <= 0) return 0;
    const A = doseMg * (ka/(ka - ke));
    return A * (Math.exp(-ke * tHours) - Math.exp(-ka * tHours));
  }
  function scaleNgPerMl(weightKg){
    const w = Math.max(20, Math.min(200, Number(weightKg)||70));
    return (PK.F * 1000) / (PK.VdLkg * w);
  }
  function effectOfDoseAt(dose, tNow, scale){
    const m = MODELS[dose.key];
    const dtH = (tNow - dose.t) / 3600000;
    let base = 0;
    if(m.kind === 'IR'){
      base = bateman(dtH, dose.mg, m.ka, m.ke);
    } else if(m.kind === 'BIPHASIC'){
      const part = 0.5*dose.mg;
      base = bateman(dtH, part, m.ka, m.ke) + bateman(dtH - m.lag2, part, m.ka, m.ke);
    } else if(m.kind === 'CONCERTA'){
      const ir = dose.mg * m.irFraction; const ext = dose.mg - ir; let sum = bateman(dtH, ir, m.ka, m.ke);
      const N=80; for(let i=0;i<N;i++){ const frac=(i+0.5)/N; const relH=m.infusionStart + frac*(m.infusionEnd-m.infusionStart); sum += bateman(dtH - relH, ext/N, m.ka, m.ke); }
      base = sum;
    }
    return base * (scale||1);
  }
  function totalEffectAt(tNow){
    const scale = scaleNgPerMl(STATE.weightKg ?? 70);
    return STATE.doses.reduce((acc,d)=> acc + effectOfDoseAt(d, tNow, scale), 0);
  }

  // UI helpers
  function pad(n){ return String(n).padStart(2,'0'); }
  function toLocalDatetimeValue(ms){ const d=new Date(ms); return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}T${pad(d.getHours())}:${pad(d.getMinutes())}`; }

  // Init
  function initMeds(){
    medSel.innerHTML = '';
    const entries = Object.entries(MODELS);
    for(const [key,m] of entries){ const opt=document.createElement('option'); opt.value=key; opt.textContent=m.label; medSel.appendChild(opt); }
    if(!medSel.value && medSel.options.length>0) medSel.value = medSel.options[0].value;
  }
  function initTimeDefault(){ timeSel.value = toLocalDatetimeValue(Date.now()); }

  // Render lists
  function renderDoseList(){
    doseList.innerHTML = '';
    const sorted = [...STATE.doses].sort((a,b)=>b.t - a.t);
    if(sorted.length===0){ doseList.innerHTML = '<div class="muted">Noch keine Einträge.</div>'; return; }
    for(const d of sorted){
      const div = document.createElement('div'); div.className='dose-item';
      const m = MODELS[d.key]; const dt = new Date(d.t);
      const strong = document.createElement('div');
      strong.innerHTML = `<strong>${m.label}</strong><br><small>${dt.toLocaleString()}</small>`;
      const del = document.createElement('button'); del.className='btn btn-ghost'; del.textContent='Entfernen';
      del.onclick = ()=>{ STATE.doses = STATE.doses.filter(x=>x.id!==d.id); save('doses', STATE.doses); redraw(); };
      div.appendChild(strong); div.appendChild(del); doseList.appendChild(div);
    }
  }
  function escapeHtml(s){ return String(s).replace(/[&<>"']/g, c=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#039;"}[c])); }
  function renderNotes(){
    notesList.innerHTML='';
    const sorted = [...STATE.notes].sort((a,b)=>b.t - a.t);
    if(sorted.length===0){ notesList.innerHTML = '<div class="muted">Noch keine Notizen.</div>'; return; }
    for(const n of sorted){
      const wrap = document.createElement('div'); wrap.className='dose-item'; const dt = new Date(n.t).toLocaleString(); const val = totalEffectAt(n.t).toFixed(2);
      const left = document.createElement('div'); left.innerHTML = `<strong>${dt}</strong><br><small>Wirkung: ${val} ng/mL</small><p style="margin:6px 0 0 0;">${escapeHtml(n.text)}</p>`;
      const del = document.createElement('button'); del.className='btn btn-ghost'; del.textContent='Entfernen'; del.onclick = ()=>{ STATE.notes = STATE.notes.filter(x=>x.id!==n.id); save('notes', STATE.notes); renderNotes(); };
      wrap.appendChild(left); wrap.appendChild(del); notesList.appendChild(wrap);
    }
  }

  // Chart
  function drawChart(){
    const now = Date.now(); const hours = STATE.hoursWindow; const steps = hours*12;
    const xs=[]; const ys=[]; let maxY=0;
    for(let i=0;i<=steps;i++){ const t = now - (hours*3600000) + i*(hours*3600000/steps); const y = totalEffectAt(t); xs.push(t); ys.push(y); if(y>maxY) maxY=y; }
    maxY = Math.max(maxY, 1);
    const W=1000, H=300, P=36; chart.innerHTML = '';
    const grid = document.createElementNS('http://www.w3.org/2000/svg', 'g');
    const step = hours <= 12 ? 2 : (hours <= 24 ? 4 : 8);
    for(let i=0;i<=hours;i+= step){
      const x = P + (W-2*P) * (i/hours);
      const line = document.createElementNS('http://www.w3.org/2000/svg','line'); line.setAttribute('x1', x); line.setAttribute('x2', x); line.setAttribute('y1', P/2); line.setAttribute('y2', H-P/2); line.setAttribute('stroke', '#2a3066'); line.setAttribute('stroke-width','1'); line.setAttribute('opacity','0.6'); grid.appendChild(line);
      const tTick = now - (hours - i) * 3600000; const timeLabel = new Date(tTick).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});
      const txt = document.createElementNS('http://www.w3.org/2000/svg','text'); txt.setAttribute('x', x); txt.setAttribute('y', H-8); txt.setAttribute('fill', '#9fb0ee'); txt.setAttribute('font-size','12'); txt.setAttribute('text-anchor','middle'); txt.textContent = timeLabel; grid.appendChild(txt);
    }
    chart.appendChild(grid);
    const path = document.createElementNS('http://www.w3.org/2000/svg','path'); let d='';
    for(let i=0;i<xs.length;i++){ const px = P + (W-2*P) * (i/(xs.length-1)); const py = (H-P) - (H-2*P) * (ys[i]/maxY); d += (i===0?`M ${px} ${py}`:` L ${px} ${py}`); }
    path.setAttribute('d', d); path.setAttribute('fill','none'); path.setAttribute('stroke','#8fb7ff'); path.setAttribute('stroke-width','4.5'); path.setAttribute('stroke-linejoin','round'); chart.appendChild(path);
    const xNow = P + (W-2*P) * (1); const vline = document.createElementNS('http://www.w3.org/2000/svg','line'); vline.setAttribute('x1', xNow); vline.setAttribute('x2', xNow); vline.setAttribute('y1', P/2); vline.setAttribute('y2', H-P/2); vline.setAttribute('stroke', '#f0f3ff'); vline.setAttribute('stroke-width','2'); vline.setAttribute('stroke-dasharray','4 4'); chart.appendChild(vline);
    for(const dse of STATE.doses){ const tRelH = (now - dse.t)/3600000; if(tRelH<0 || tRelH>hours) continue; const px = P + (W-2*P) * (1 - tRelH/hours); const py = (H-P) - (H-2*P) * (totalEffectAt(dse.t)/maxY); const circ = document.createElementNS('http://www.w3.org/2000/svg','circle'); circ.setAttribute('cx', px); circ.setAttribute('cy', py); circ.setAttribute('r','7'); circ.setAttribute('fill', MODELS[dse.key].color); circ.style.cursor='pointer'; circ.addEventListener('click', ()=>{ const m = MODELS[dse.key]; alert(`${m.label}
${new Date(dse.t).toLocaleString()}`); }); chart.appendChild(circ); }
    nowValue.textContent = totalEffectAt(now).toFixed(2);
  }
  function redraw(){ renderDoseList(); renderNotes(); drawChart(); }

  // Events
  addDoseBtn.onclick = ()=>{ const key = medSel.value; const model = MODELS[key]; if(!model) return alert('Bitte Präparat wählen.'); const t = new Date(timeSel.value).getTime(); if(!Number.isFinite(t)) return alert('Bitte gültige Zeit wählen.'); STATE.doses.push({ id: uid(), key, mg: model.mg, t }); save('doses', STATE.doses); redraw(); };
  addNowBtn.onclick = ()=>{ timeSel.value = toLocalDatetimeValue(Date.now()); };
  btn12.onclick = ()=>{ STATE.hoursWindow=12; drawChart(); };
  btn24.onclick = ()=>{ STATE.hoursWindow=24; drawChart(); };
  btn48.onclick = ()=>{ STATE.hoursWindow=48; drawChart(); };
  saveNoteBtn.onclick = ()=>{ const text = noteTxt.value.trim(); if(!text) return; STATE.notes.push({ id: uid(), t: Date.now(), text }); save('notes', STATE.notes); noteTxt.value=''; renderNotes(); };
  clearBtn.onclick = ()=>{ if(confirm('Wirklich ALLE Dosen & Notizen löschen?')){ STATE.doses=[]; STATE.notes=[]; save('doses',STATE.doses); save('notes',STATE.notes); redraw(); } };
  exportBtn.onclick = ()=>{
    const days = Math.max(1, Math.min(60, parseInt(prompt('Zeitraum in Tagen für den Arzt‑Export (1–60):', '14')||'14', 10)));
    const html = buildDoctorReportHTML(days);
    const w = window.open('about:blank'); if(!w){ alert('Popup blockiert? Erlaube Popups.'); return; }
    w.document.open(); w.document.write(html); w.document.close(); setTimeout(()=>{ try{ w.focus(); w.print(); } catch(e){} }, 400);
  };

  // Settings modal
  function showSettings(first=false){ settingsModal.classList.add('show'); settingsModal.setAttribute('aria-hidden','false'); modalWeight.value = STATE.weightKg ?? ''; modalCancel.style.display = first ? 'none' : ''; }
  function hideSettings(){ settingsModal.classList.remove('show'); settingsModal.setAttribute('aria-hidden','true'); }
  if(openSettingsBtn) openSettingsBtn.onclick = ()=> showSettings(false);
  modalSave.onclick = ()=>{ const v = parseFloat(modalWeight.value); if(isNaN(v) || v<20 || v>200){ alert('Bitte Gewicht zwischen 20 und 200 kg eingeben.'); return; } STATE.weightKg = v; save('weightKg', v); hideSettings(); drawChart(); };
  modalCancel.onclick = ()=> hideSettings();

  // Boot
  function boot(){
    initMeds(); initTimeDefault(); renderDoseList(); renderNotes(); drawChart();
    if('serviceWorker' in navigator){ navigator.serviceWorker.register('./service-worker.js').catch(console.warn); }
    // Erststart: Gewicht abfragen
    if(localStorage.getItem('weightKg')===null){ showSettings(true); }
  }
  boot();
  </script>
</body>
</html>